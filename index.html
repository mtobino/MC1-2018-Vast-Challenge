<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>VAST</title>
        <script type="text/javascript" src="d3/d3.v3.js"></script>
        
        <script type="text/javascript" src="birdsounds/bird-sounds-db-sample-hq.js"></script>
        <script type="text/javascript" src="birdsounds/bird-sounds-metadata.js"></script>

        <script type="text/javascript" src="birdsounds/test-bird-sounds-db.js"></script>

        <script type="text/javascript" src="kissfft/kissfft.js"></script>
        <script type="text/javascript" src="kissfft/kissfft-wrapper.js"></script>
        
        <script type="text/javascript" src="magma-colormap.js"></script>
        <script type="text/javascript" src="spectrogram.js"></script>


        <style type="text/css">
            .axis path, .axis line {
                fill: none;
                stroke: black;
                shape-rendering: crispEdges;
            }
            .axis text {
                font-family: sans-serif;
                font-size: 0.75em;
                fill: black;
            }
            .axis-label {
                font-family: sans-serif;
                font-size: 0.8em;
                fill: black;
            }
            .info {
                height: 45vh;
                margin-top: 1em;
                display: flex;
                flex-direction: row;
            }
            .spectrogram {
                width: 100%;
                height: 100%;
                border: 1px solid black;
                position: relative;
            }
            .spectrogram canvas {
                position: absolute;
                top: 1em;
                left: 4em;
                width: calc(100% - 8em);
                height: calc(100% - 3.5em);
                z-index: 1;
                border: 1px solid white;
            }
            .spectrogram .overlay {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 2;
            }

            .side-panel {
                height: 100%;
                border: 1px solid black;
                margin-left: 1em;
                padding-left: .5em;
                padding-right: .5em;
            }
            .sound-selection div {
                display: flex;
                justify-content: space-between;
                margin-bottom: 0.25em;
            }
            .sound-selection p, h4, h3, h2, h1 {
                margin: 0;
            }
            #metadata p, h4, h3, h2, h1 {
                margin: 0;
            }

            .playhead line {
                stroke: #00FF00;
                stroke-width: 1px;
            }
        </style>
    </head>
    <body>
        <div class="info">
            <div id="main-spectrogram"></div>
            <div class="side-panel">
                <div class="sound-selection">
                    <h3>Bird Selection</h3>
                    <div>
                        <label for="bird-name">Bird: </label>
                        <select id="bird-name" name="bird-name">
                        </select>
                    </div>
                    <div>
                        <label for="vocalization-type">Vocalization Type: </label>
                        <select id="vocalization-type" name="vocalization-type">
                        </select>
                    </div>
                    <div>
                        <label for="file-id">File ID: </label>
                        <select id="file-id" name="file-id">
                        </select>
                    </div>
                </div>
                <div id="metadata">
                    <h3>Metadata</h3>
                </div>
                <audio id="main-audio-controls" controls></audio>
            </div>
        </div>
        <div class="info">
            <div id="test-bird-spectrogram"></div>
            <div class="side-panel">
                <div class="sound-selection">
                    <h3>Kaisos' Test Bird Selection</h3>
                    <label for="test-bird-id">Id: </label>
                    <select id="test-bird-id" name="test-bird-id"><select>
                    </select>
                </div>
                <div id="metadata">
                    <h3>Metadata</h3>
                </div>
                <audio id="test-bird-audio-controls" controls></audio>
            </div>
        </div>

        <script type="text/javascript">
            // Filter out vocalization types and file ids that don't exist in bird-sounds-db.js
            for (const englishName in birdSoundsDrillDown) {
                const byVocalizationType = birdSoundsDrillDown[englishName];
                for (const vocalizationType in byVocalizationType) {
                    byVocalizationType[vocalizationType] = byVocalizationType[vocalizationType]
                        .filter(fileId => birdSounds[fileId] !== undefined);
                    if (byVocalizationType[vocalizationType].length == 0) {
                        delete byVocalizationType[vocalizationType];
                    } else {
                        byVocalizationType[vocalizationType].sort((a, b) => parseInt(a) - parseInt(b));
                    }
                }
            }

            var mainSpectrogram = {
                audioData: undefined,
                audioObjectUrl: "",
                audioControls: d3.select("#main-audio-controls"),
                visualization: new SpectrogramVisualization(document.getElementById("main-spectrogram"))
            };
            var testBirdSpectrogram = {
                audioData: undefined,
                audioObjectUrl: "",
                audioControls: d3.select("#test-bird-audio-controls"),
                visualization: new SpectrogramVisualization(document.getElementById("test-bird-spectrogram"))
            };

            function getSelectedBirdName() {
                return document.getElementById("bird-name").value;
            }
            function getSelectedVocalizationType() {
                return document.getElementById("vocalization-type").value;
            }
            function getSelectedFileId() {
                return document.getElementById("file-id").value;
            }

            function getSelectedTestBirdId() {
                return document.getElementById("test-bird-id").value;
            }

            function updateList(selector, dataset) {
                let selection = d3.select(selector)
                    .selectAll("option")
                    .data(dataset);
                // Add new options
                selection.enter()
                    .append("option");
                // Update value and text of new and old options
                selection.attr("value", (d) => d)
                    .text((d) => d);
                // Remove extra options
                selection.exit()
                    .remove()
            }
            
            function updateVocalizationTypeList() {
                let birdName = getSelectedBirdName();
                let vocalizationTypes = Object.getOwnPropertyNames(birdSoundsDrillDown[birdName]);
                vocalizationTypes.sort();
                updateList("#vocalization-type", vocalizationTypes);
                updateFileIdList();
            }

            function updateFileIdList() {
                let birdName = getSelectedBirdName();
                let vocalizationType = getSelectedVocalizationType();
                let fileIds = birdSoundsDrillDown[birdName][vocalizationType];
                updateList("#file-id", fileIds);
                onFileIdSelected();
            }

            function onFileIdSelected() {
                let fileId = getSelectedFileId();
                let metadataNames = {"quality": "Quality", "time": "Time", "year": "Year", "x": "X", "y": "Y"};
                let metadataOrder = ["time", "year", "quality", "x", "y"];

                d3.select("#metadata")
                    .selectAll("p")
                    .remove();

                let p = d3.select("#metadata")
                    .selectAll("p")
                    .data(metadataOrder)
                    .enter()
                    .append("p");
                p.append("strong")
                    .text((d) => metadataNames[d] + ": ");
                p.append("span")
                    .text((d) => birdSoundsByFileId[fileId][d]);

                setAudio(birdSounds, fileId, mainSpectrogram);
            }

            function onTestBirdIdSelected() {
                let testBirdId = getSelectedTestBirdId();
                setAudio(testBirdSounds, testBirdId, testBirdSpectrogram);
            }

            let birdNames = Object.getOwnPropertyNames(birdSoundsDrillDown);
            birdNames.sort();
            updateList("#bird-name", birdNames);
            
            d3.select("#bird-name")
                .on("change", updateVocalizationTypeList);
            d3.select("#vocalization-type")
                .on("change", updateFileIdList);
            d3.select("#file-id")
                .on("change", onFileIdSelected);
            updateVocalizationTypeList();

            let testBirdIds = Object.getOwnPropertyNames(testBirdSounds);
            updateList("#test-bird-id", testBirdIds);

            d3.select("#test-bird-id")
                .on("change", onTestBirdIdSelected);
            onTestBirdIdSelected();

            function setAudio(source, fileId, spectrogramObj) {
                if (spectrogramObj.audioObjectURL != "") {
                    URL.revokeObjectURL(spectrogramObj.audioObjectURL);
                }
                console.log(`Setting audio file to ${fileId}`);
                let binString = atob(source[fileId]);
                spectrogramObj.audioData = Uint8Array.from(binString, (m) => m.charCodeAt(0));
                spectrogramObj.audioObjectURL = URL.createObjectURL(new Blob([spectrogramObj.audioData], {type: 'audio/opus'}));
                if (spectrogramObj.audioControls) {
                    spectrogramObj.audioControls.property("src", spectrogramObj.audioObjectURL);
                }
                spectrogramObj.visualization.updateSpectrogram(spectrogramObj.audioData);
            }
            
            function linkAudioControls(spectrogramObj) {
                let audioControls = spectrogramObj.audioControls.node();
                var playHeadInterval = -1;
                function updatePlayhead() {
                    spectrogramObj.visualization.updatePlayhead(!audioControls.paused, audioControls.currentTime);
                    if (audioControls.paused) {
                        clearInterval(playHeadInterval);
                    }
                }
                spectrogramObj.audioControls
                    .on("play", () => {
                        clearInterval(playHeadInterval);
                        playHeadInterval = setInterval(updatePlayhead, 1000/30);
                    })
                    .on("timeupdate", updatePlayhead)
                    .on("ended", () => {
                        clearInterval(playHeadInterval);
                        updatePlayhead();
                    });
            }
            linkAudioControls(mainSpectrogram);
            linkAudioControls(testBirdSpectrogram);
        </script>
    </body>
</html>
